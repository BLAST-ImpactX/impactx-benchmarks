#!/usr/bin/env bash
#

# fail script on any error
set -eu -o pipefail

# cleanup
rm -rf {{ dir_impactx_src }} {{ dir_impactx_build }}

# get source
git clone -b {{ version }} https://github.com/{{ gh_owner }}/impactx.git {{ dir_impactx_src }}

# change CXXFLAGS, LDFLAGS
#   conda-forge compiler flags are sub-optimal in performance (-O2, etc.)
#     -fvisibility-inlines-hidden -fmessage-length=0 -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /home/axel/micromamba/envs/warpx-cpu-mpich-dev/include
#
export CFLAGS=""
export CXXFLAGS="{{ CXXFLAGS }}"
export LDFLAGS=""
export CUDAARCHS=""
export CUDAFLAGS=""
export CUDA_CFLAGS=""
export CUDA_LDFLAGS=""
export HIPFLAGS=""

# configure
cmake --fresh                                     \
      -S {{ dir_impactx_src }}                    \
      -B {{ dir_impactx_build }}                  \
      -G Ninja                                    \
      -DCMAKE_INSTALL_PREFIX=${CONDA_PREFIX}      \
      -DImpactX_FFT=ON                            \
      -DImpactX_SIMD={{ ImpactX_SIMD }}           \
      -DImpactX_OPENPMD=OFF                       \
      -DImpactX_PYTHON=ON                         \
      -DImpactX_MPI=OFF                           \
      -DImpactX_COMPUTE={{ ImpactX_COMPUTE }}     \
      -DImpactX_PRECISION={{ ImpactX_PRECISION | default("SINGLE") }}

# build & install
cmake                                \
    --build {{ dir_impactx_build }}  \
    -j {{ build_nproc }}             \
    --target install
cmake                                \
    --build {{ dir_impactx_build }}  \
    -j {{ build_nproc }}             \
    --target pip_install

# cleanup
rm -rf {{ dir_impactx_src }} {{ dir_impactx_build }}
